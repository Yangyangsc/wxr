<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
  <title>活动报名</title>
  <!-- build:css css/style.css -->
  <link rel="stylesheet" href="../bower_components/weui/dist/style/weui.css">
  <link rel="stylesheet" type="text/css" href="../css/main.css">
  <link rel="stylesheet" type="text/css" href="../css/message.css">
  <script src="../bower_components/zepto/zepto.min.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" src="../js/wechatHelper.js"></script>
  <script type="text/javascript" src="../js/common.js"></script>
  <script type="text/javascript" src="../js/apiCaller.js"></script>
  <script type="text/javascript" src="../bower_components/dot/doT.min.js"></script>
  <script type="text/javascript" src="../js/message.js"></script>
  <script src="../js/lib/weui.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
  <script src="../js/urlConfig.js" type="text/javascript" charset="utf-8"></script>

  <!-- endbuild -->

  <!-- build:js js/main.js -->
  <!-- endbuild -->
</head>

<body>
  <form id="orderForm">

    <div class="weui-panel weui-panel_access save-order-activity">
      <div class="weui-panel__bd">
        <a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg">
          <div class="weui-media-box__hd">
            <img class="weui-media-box__thumb" id="imgBanner" src="../images/thumb_1.jpg" alt="">
          </div>
          <div class="weui-media-box__bd">
            <div class="weui-media-box__title" style="word-wrap:break-word;white-space:normal">
              <!--<h4 ></h4>-->
            </div>
            <p class="weui-media-box__desc"> <br></p>
          </div>
        </a>
      </div>
    </div>
    <div class="weui-cells save-order-cells">
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p id="ticketTypeFront">购票类型</p>
        </div>
        <div class="weui-cell__ft">
          <span class="text" id="ticketType"></span>
        </div>
      </div>
    </div>
    <div class="weui-cells save-order-cells">
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p id='priceFront'>票面单价</p>
        </div>
        <div class="weui-cell__ft">
          <span class="text text-red" id='price'></span>
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p>数量</p>
        </div>
        <div class="weui-cell__ft">
          <img src="../images/remove.png" id="remove-btn" alt="">
          <input class="weui-input" id="number" value="1" disabled required pattern="[0-9]" style="color:#333333;opacity:1" placeholder="购票数量"
            emptyTips="请输入数量" notMatchTips="请输入正确的数量">
          <img src="../images/add.png" id="add-btn" alt="">
        </div>
      </div>
    </div>
    <div class="weui-cells save-order-cells">
      <div class="weui-cell" id="orderTotalContainer">
        <div class="weui-cell__bd">
          <p>订单金额</p>
        </div>
        <div class="weui-cell__ft">
          <span class="text text-red" id="ticketPrice"></span>
        </div>
      </div>
      <div class="weui-cell fromchannel" style='display:none;' id="channelContainer">
        <div class="weui-cell__bd">
          <p>渠道来源</p>
        </div>
        <div class="weui-cell__ft">
          <span class="text" id="code"></span>
        </div>
      </div>
      <div class="weui-cell fromchannel" style='display:none;' id="channelDiscount">
        <div class="weui-cell__bd">
          <p>优惠金额</p>
        </div>
        <div class="weui-cell__ft">
          <span class="text text-red" id="discount"></span>
        </div>
      </div>
    </div>
    <div class="weui-cells save-order-cells ">
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p>参加人姓名</p>
        </div>
        <div class="weui-cell__ft">
          <input class="weui-input" type="text" id="username" required placeholder="必填" emptyTips="请输入参加人姓名" notMatchTips="请输入参加人姓名">
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p>联系电话</p>
        </div>
        <div class="weui-cell__ft">
          <input class="weui-input" type="tel" id="tel" required placeholder="必填" emptyTips="请输入联系电话" notMatchTips="请输入联系电话">
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p>工作单位</p>
        </div>
        <div class="weui-cell__ft">
          <input class="weui-input" type="text" id="company" required placeholder="必填" emptyTips="请输入工作单位" notMatchTips="请输入工作单位">
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p>工作职务</p>
        </div>
        <div class="weui-cell__ft">
          <input class="weui-input" type="text" id="position" placeholder="工作职务(选填)" emptyTips="请输入工作职务" notMatchTips="请输入工作职务">
        </div>
      </div>
    </div>
    <div class="weui-cells save-order-cells" style="display: none">
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <p>配送方式</p>
        </div>
        <div class="weui-cell__ft">
          <span class="text">电子票</span>
        </div>
      </div>
    </div>


    <div class="bottom-button__fixed">
      <div class="save-order-bottom">
        <div class="weui-flex">
          <div class="weui-flex__item" id="paymentDisplay">
            <b>支付金额:</b> <span class="text text-red" id="totalPrice"></span>
          </div>
          <div class="weui-flex__item" style="background-color: #00d62a" id="btnPay">
            <a href="javascript:;" id="btnPayButton" class="weui-btn weui-btn_primary" style="border:0px none">立即支付</a>
          </div>
        </div>
      </div>
    </div>
  </form>
  <script>
    ///当前用户的微信 openid
    ///从上一个页面过来的用户选择的票类型id(ticketid)
    ///从渠道引流过来的渠道信息id(channelid)
    var openid, ticketid, channelid, isgift, giftid;
    var bindhandle = function () {
      $("#btnPay").on('click', function () {
        validForm();
      })
      $("#number").on("change", function (e) {
        var count = $(this).val() || 1;
        if (isNaN(count))
          $(this).val(1);
        reloadPrice($(this).val());
      })
      if (isgift != 1) {
        $("#remove-btn").on('click', function () {
          var count = $("#number").val() || 1;
          var newCount = parseInt(count) <= 1 ? parseInt(count) : parseInt(count) - 1;
          $("#number").val(newCount);
          reloadPrice(newCount);
        });
        $("#add-btn").on('click', function () {
          var count = $("#number").val() || 1;
          var newCount = parseInt(count) + 1;
          $("#number").val(newCount);
          reloadPrice(newCount);
        });
      }
    }
    var validForm = function () {
      // weui.form.validate('#form', function(error){ console.log(error);}); // error: {dom:[Object], msg:[String]}

      weui.form.validate('#orderForm', function (error) {
        if (!error) {
          if (common.isMobileNo($("#tel").val()) == false) {
            message.toast('请输入正确的手机号码', messageType.warning);
            return;
          }
          submit()
        }
        // return true; // 当return true时，不会显示错误
      });
    }
    var submit = function () {
      apiCaller.call('orders', {
        waitingMessage: '订单提交中...',
        data: {
          userid: openid,
          mobile: $("#tel").val(),
          ticketid: ticketid,
          username: $("#username").val(),
          company: $("#company").val(),
          position: $("#position").val(),
          total: $("#number").val(),
          giftid: giftid,      ////赠票传送过去
          tickettype: '',
          channelid: channelid
        },
        success: function (result) {
          if (result.successed && result.rows.length > 0) {
            if (isgift == 0) {   ////如果非赠票，开启微信支付
              var orderData = result.rows[0];
              openWechatPay(orderData.orderid)
            }
            else {    ////否则直接跳转到成功
              document.location.href = './success.html?cover=' + activityCover;
            }
          }
          else {
            message.toast(result.message, messageType.warning);
          }
        },
        error: function (error) {
          var errMsg = common.isEmpty(error.message) ? '' : ('<br/>' + error.message);
          message.toast('订单提交失败!' + error.message, messageType.warning);
        }
      })
    }
    var openWechatPay = function (orderid) {
      var jsApiCall = null;
      apiCaller.call('/wechat/mp/pay', {
        waitingMessage: '准备微信支付...',
        data: {
          uid: openid,
          orderid: orderid,
        },
        success: function (result) {
          //alert(JSON.stringify(result));
          if (result.successed) {
            jsApiCall = function jsApiCall() {
              WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                result.result,//josn串
                function (res) {
                  WeixinJSBridge.log(res.err_msg);
                  if (res.err_msg == "get_brand_wcpay_request:ok") {
                    document.location.href = './success.html?cover=' + activityCover;
                  } else {
                    message.toast('支付失败，请重试!', messageType.warning);
                  }
                }
              );
            }

              (function callpay() {
                if (typeof WeixinJSBridge == "undefined") {
                  if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
                  }
                  else if (document.attachEvent) {
                    document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                    document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
                  }
                }
                else {
                  jsApiCall();
                }
              })();
          }
          else {
            message.toast('支付失败，请重试!', messageType.warning);
          }
        },
        error: function (error) {
          message.toast('支付失败，请重试!', messageType.error);
        }
      })
    }
    var reloadPrice = function (count) {
      var activity_price = common.getCache('activity_price') ? parseFloat(common.getCache('activity_price')) : 0;
      var channeldiscount = common.getCache('channeldiscount') ? parseFloat(common.getCache('channeldiscount')) : 0;
      var totalPrice = (parseFloat(channeldiscount) * count * activity_price / 100.0)
      var discount = (activity_price * count) - totalPrice;

      $("#ticketPrice").text("￥" + (activity_price * count).toFixed(2));
      $("#discount").text("－￥" + discount.toFixed(2));
      $("#totalPrice").text("￥" + totalPrice.toFixed(2))
    }
    var activityCover;
    var initLoad = function () {
      //var cid = common.query().cid;
      apiCaller.call('tickets/' + ticketid, {
        data: {
          cid: channelid,
          gid: giftid,
          uid: openid
        },
        type: 'get',
        success: function (result) {
          if (result.successed && result.rows.length > 0) {
            var rowData = result.rows[0];
            isgift = rowData.channel_gift;
            if (isgift != 1) {
              giftid = '';
              isgift = 0;
            }

            var count = $("#number").val() || 1;
            $("#imgBanner").attr('src', imageServer + rowData.activity_cover);
            activityCover = rowData.activity_cover;
            ///没有从渠道这边过来的,则隐藏渠道的相关栏位显示
            if (!common.isEmpty(rowData.channelname)) $(".fromchannel").show();
            var totalPrice = (rowData.channeldiscount / 100) * count * rowData.activity_price
            var discount = (rowData.activity_price * count) - totalPrice;
            ///如果活动是一天，则只需要显示一个日期 + 两个时间，否则都显示
            var dateTimeString = common.combine2DateString(rowData.activity_date_start, rowData.activity_date_end);

            var desc = dateTimeString + ' </br>' + rowData.activity_city_name + ' -' + rowData.activity_location;

            common.addCache('activity_price', "" + rowData.activity_price);
            common.addCache('channeldiscount', "" + rowData.channeldiscount);
            ///如果界面是赠票，隐藏相关的一些信息，调整一些相关文字
            if (isgift == 1) {
              $("#add-btn,#remove-btn").hide();
              $('#btnPayButton').text("领取赠票");
              $('#channelContainer>p').text("赠票渠道");
              $('#ticketTypeFront').text('赠票类型');
              $('#priceFront').text('赠票价值');
              $('#orderTotalContainer').hide();
              $('#paymentDisplay').hide();
              $('#btnPay,#btnPayButton').css('backgroundColor', '#ae00c3');
              ///赠送模式下渠道折扣不再显示
              rowData.channeldiscount = 100;
            }
            reloadPrice(count);

            $(".weui-media-box__title").text(rowData.activity_topic);
            $(".weui-media-box__desc").html(desc);
            $("#ticketType").text(common.replace(rowData.ticket_title,'<br/>',''));
            $("#price").text("￥" + rowData.activity_price);


            $("#code").text(rowData.channelname + (rowData.channeldiscount < 100 ? ('（' + (rowData.channeldiscount / 10.0) + '折）') : ''));
            if (rowData.channeldiscount >= 100 || isgift == 1) {
              $("#channelDiscount").hide();
            }

          }

        }
      })
    }
    $(function () {
      ///从URL中获取到当前微信用户的openid
      openid = common.query().openid;
      ///从上一个页面过来的用户选择的票类型id
      ticketid = common.query().id;
      ///从URL中获取到渠道id
      channelid = common.query().cid;
      ///该票是否是赠票
      //isgift = common.query().isgift;
      ///赠票的id
      giftid = common.query().giftid;
      //if (isgift!="1") isgift=0;

      if (common.isEmpty(openid) || common.isEmpty(ticketid))
        alert('页面缺失重要参数，非法加载!');
      else {
        initLoad();
        bindhandle();
        ///初始化微信分享
        common.createWXShareInit(null, function () {
          wechatHelper.hideCopyLink();
        });
      }
    })
  </script>
</body>

</html>